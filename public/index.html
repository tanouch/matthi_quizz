<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fall Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0f; --surface:#14141f; --surface2:#1e1e2e;
    --accent:#ff3e6c; --accent2:#7c3aed; --green:#10b981;
    --red:#ef4444; --yellow:#fbbf24; --text:#e2e2ef; --dim:#6b6b80;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 50%,rgba(124,58,237,.08)0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(255,62,108,.06)0%,transparent 50%);z-index:-1}

  .screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;padding:24px}
  .screen.active{display:flex}

  .logo{font-size:clamp(3rem,8vw,5rem);font-weight:900;letter-spacing:-3px;margin-bottom:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .subtitle{font-family:'Space Mono',monospace;color:var(--dim);font-size:.85rem;margin-bottom:48px;letter-spacing:2px;text-transform:uppercase}

  .card{background:var(--surface);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:32px;width:100%;max-width:400px}
  label{display:block;font-size:.75rem;font-family:'Space Mono',monospace;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
  input{width:100%;padding:14px 16px;background:var(--bg);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:1rem;outline:none}
  input:focus{border-color:var(--accent2)}
  .ig{margin-bottom:16px}

  .btn{width:100%;padding:16px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;transition:all .2s}
  .btn:active{transform:scale(.97)}
  .btn-p{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .btn-s{background:var(--surface2);color:var(--text);border:1px solid rgba(255,255,255,.08);margin-top:10px}
  .divider{text-align:center;color:var(--dim);font-size:.8rem;margin:18px 0;font-family:'Space Mono',monospace}
  .error{color:var(--red);font-size:.85rem;margin-top:10px;text-align:center;min-height:1.2em}

  .room-code{font-family:'Space Mono',monospace;font-size:clamp(2.5rem,7vw,4rem);font-weight:700;letter-spacing:12px;color:var(--accent);text-align:center;margin:16px 0 6px}
  .room-label{font-family:'Space Mono',monospace;font-size:.7rem;color:var(--dim);text-transform:uppercase;letter-spacing:3px;text-align:center}

  .player-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:32px 0;max-width:500px}
  .chip{background:var(--surface2);border:1px solid rgba(255,255,255,.06);padding:10px 18px;border-radius:50px;font-weight:500}
  .chip.host{border-color:var(--accent)}.chip.host::before{content:'üëë '}
  .wait{color:var(--dim);font-size:.85rem;animation:pulse 2s infinite}
  @keyframes pulse{50%{opacity:.5}}

  .q-header{font-family:'Space Mono',monospace;font-size:.75rem;color:var(--dim);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px}
  .timer-bar{width:100%;max-width:500px;height:4px;background:var(--surface2);border-radius:4px;margin-bottom:32px;overflow:hidden}
  .timer-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--yellow),var(--red));border-radius:4px;transition:width 1s linear}
  .q-text{font-size:clamp(1.3rem,4vw,1.8rem);font-weight:700;text-align:center;max-width:600px;line-height:1.4;margin-bottom:36px}

  .opts{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:500px}
  @media(max-width:500px){.opts{grid-template-columns:1fr}}
  .opt{padding:18px 20px;background:var(--surface);border:2px solid rgba(255,255,255,.06);border-radius:12px;color:var(--text);font-family:'Outfit',sans-serif;font-size:1rem;font-weight:500;cursor:pointer;transition:all .2s;text-align:left}
  .opt:hover:not(.dis){border-color:var(--accent2);background:var(--surface2)}
  .opt.sel{border-color:var(--accent2);background:rgba(124,58,237,.15)}
  .opt.correct{border-color:var(--green)!important;background:rgba(16,185,129,.15)!important}
  .opt.wrong{border-color:var(--red)!important;background:rgba(239,68,68,.1)!important;opacity:.6}
  .opt.dis{pointer-events:none}
  .ol{display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:6px;background:rgba(255,255,255,.06);font-family:'Space Mono',monospace;font-size:.75rem;margin-right:10px}

  /* FALLING LEADERBOARD */
  .st-wrap{padding:24px;width:100%;max-width:600px}
  .st-title{font-size:1rem;font-family:'Space Mono',monospace;color:var(--dim);text-transform:uppercase;letter-spacing:2px;text-align:center;margin-bottom:8px}
  .st-correct{text-align:center;font-size:1.1rem;font-weight:700;color:var(--green);margin-bottom:24px}

  .cliff{position:relative;width:100%;border:1px solid rgba(255,255,255,.04);border-radius:14px;overflow:hidden}
  .cliff-bg{position:absolute;inset:0;background:linear-gradient(180deg,rgba(16,185,129,.08) 0%,rgba(251,191,36,.05) 50%,rgba(239,68,68,.1) 100%);pointer-events:none}
  .cliff-inner{position:relative;z-index:1;padding:12px}

  .p-row{display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:8px;border-radius:10px;background:rgba(255,255,255,.03);position:relative;overflow:hidden;transition:all .6s cubic-bezier(.22,1,.36,1)}
  .p-row.fell{animation:shake .5s ease}
  @keyframes shake{20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}}

  .p-depth-bar{position:absolute;left:0;top:0;bottom:0;border-radius:10px;opacity:.12;transition:width .8s ease}
  .p-rank{font-family:'Space Mono',monospace;font-weight:700;font-size:.85rem;color:var(--dim);min-width:28px}
  .p-avatar{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0}
  .p-info{flex:1;min-width:0}
  .p-name{font-weight:600;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .p-status{font-size:.75rem;font-family:'Space Mono',monospace;margin-top:2px}
  .p-status.ok{color:var(--green)}.p-status.ko{color:var(--red)}.p-status.no{color:var(--dim)}
  .p-score{font-family:'Space Mono',monospace;font-weight:700;font-size:1.1rem;min-width:50px;text-align:right}

  .next-wrap{text-align:center;margin-top:24px}

  .trophy{font-size:4rem;margin-bottom:8px}
  .winner{font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--yellow),#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .wlabel{font-family:'Space Mono',monospace;font-size:.75rem;color:var(--dim);text-transform:uppercase;letter-spacing:3px;margin-bottom:32px}
  .fl{width:100%;max-width:400px}
  .fr{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;margin-bottom:6px;background:var(--surface)}
  .fr:first-child{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.2)}
  .fr-r{font-family:'Space Mono',monospace;font-weight:700;min-width:28px;color:var(--dim)}
  .fr-n{flex:1;font-weight:600}
  .fr-s{font-family:'Space Mono',monospace;font-weight:700}
</style>
</head>
<body>

<div id="s-home" class="screen active">
  <div class="logo">FALL</div>
  <div class="subtitle">Don't hit the bottom</div>
  <div class="card">
    <div class="ig"><label>Your Name</label><input id="i-name" placeholder="Enter your name" maxlength="16"></div>
    <button class="btn btn-p" id="b-create">Create Room</button>
    <div class="divider">‚Äî or ‚Äî</div>
    <div class="ig"><label>Room Code</label><input id="i-code" placeholder="ABCD" maxlength="4" style="text-transform:uppercase;letter-spacing:6px;text-align:center;font-family:'Space Mono',monospace;font-size:1.3rem"></div>
    <button class="btn btn-s" id="b-join">Join Room</button>
    <div class="error" id="err"></div>
  </div>
</div>

<div id="s-lobby" class="screen">
  <div class="room-label">Room Code</div>
  <div class="room-code" id="l-code"></div>
  <p style="color:var(--dim);font-size:.8rem;margin-bottom:8px">Share this code with friends</p>
  <div class="player-list" id="p-list"></div>
  <button class="btn btn-p" id="b-start" style="max-width:300px;display:none">Start Game</button>
  <div class="wait" id="w-start">Waiting for host to start‚Ä¶</div>
</div>

<div id="s-question" class="screen">
  <div class="q-header" id="qh"></div>
  <div class="timer-bar"><div class="timer-fill" id="tf"></div></div>
  <div class="q-text" id="qt"></div>
  <div class="opts" id="qo"></div>
</div>

<div id="s-standings" class="screen">
  <div class="st-wrap">
    <div class="st-title" id="st-title"></div>
    <div class="st-correct" id="st-correct"></div>
    <div class="cliff">
      <div class="cliff-bg"></div>
      <div class="cliff-inner" id="st-list"></div>
    </div>
    <div class="next-wrap">
      <button class="btn btn-p" id="b-next" style="max-width:300px;display:none">Next Question</button>
      <div class="wait" id="w-next" style="display:none">Next question coming‚Ä¶</div>
    </div>
  </div>
</div>

<div id="s-gameover" class="screen">
  <div class="trophy">üèÜ</div>
  <div class="winner" id="go-winner"></div>
  <div class="wlabel">Champion</div>
  <div class="fl" id="go-list"></div>
  <button class="btn btn-s" id="b-replay" style="max-width:300px;margin-top:16px">Play Again</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let isHost=false, myId=null, totalQ=10;
const COLORS=['#ff3e6c','#7c3aed','#10b981','#f59e0b','#3b82f6','#ec4899','#14b8a6','#f97316','#8b5cf6','#06b6d4','#ef4444','#84cc16'];
let colorMap={}, ci=0;
function pColor(id){if(!colorMap[id])colorMap[id]=COLORS[ci++%COLORS.length];return colorMap[id]}
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('s-'+id).classList.add('active')}
function err(m){const e=document.getElementById('err');e.textContent=m;setTimeout(()=>e.textContent='',3000)}

document.getElementById('b-create').onclick=()=>{
  const name=document.getElementById('i-name').value.trim();
  if(!name)return err('Enter your name');
  socket.emit('create-room',name,r=>{if(r.error)return err(r.error);isHost=true;document.getElementById('l-code').textContent=r.code;show('lobby')});
};
document.getElementById('b-join').onclick=()=>{
  const name=document.getElementById('i-name').value.trim(),code=document.getElementById('i-code').value.trim().toUpperCase();
  if(!name)return err('Enter your name');if(code.length<4)return err('Enter 4-letter code');
  socket.emit('join-room',code,name,r=>{if(r.error)return err(r.error);document.getElementById('l-code').textContent=r.code;show('lobby')});
};
document.getElementById('i-name').onkeydown=e=>{if(e.key==='Enter')document.getElementById('b-create').click()};
document.getElementById('i-code').onkeydown=e=>{if(e.key==='Enter')document.getElementById('b-join').click()};

socket.on('players-update',players=>{
  myId=socket.id;
  const list=document.getElementById('p-list');list.innerHTML='';
  players.forEach(p=>{const d=document.createElement('div');d.className='chip'+(p.isHost?' host':'');d.textContent=p.name;list.appendChild(d)});
  isHost=players.find(p=>p.id===socket.id)?.isHost;
  document.getElementById('b-start').style.display=isHost?'block':'none';
  document.getElementById('w-start').style.display=isHost?'none':'block';
});
document.getElementById('b-start').onclick=()=>socket.emit('start-game');

socket.on('game-started',d=>{totalQ=d.totalQuestions;show('question')});

socket.on('new-question',d=>{
  show('question');
  document.getElementById('qh').textContent=`Question ${d.index+1} / ${d.total}`;
  document.getElementById('qt').textContent=d.question;
  const grid=document.getElementById('qo');grid.innerHTML='';
  const labels='ABCDEFGH';
  d.options.forEach((opt,i)=>{
    const b=document.createElement('button');b.className='opt';
    b.innerHTML=`<span class="ol">${labels[i]}</span>${opt}`;
    b.onclick=()=>{grid.querySelectorAll('.opt').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');socket.emit('submit-answer',i)};
    grid.appendChild(b);
  });
  const tf=document.getElementById('tf');tf.style.transition='none';tf.style.width='100%';
  requestAnimationFrame(()=>{tf.style.transition=`width ${d.timeLimit}s linear`;tf.style.width='0%'});
});

socket.on('answer-reveal',data=>{
  document.querySelectorAll('.opt').forEach((b,i)=>{b.classList.add('dis');b.classList.add(i===data.correctIndex?'correct':'wrong')});
  setTimeout(()=>renderStandings(data),1200);
});

function renderStandings(data){
  show('standings');
  document.getElementById('st-title').textContent=`After Question ${data.questionIndex+1}`;
  document.getElementById('st-correct').textContent=`‚úì ${data.correctAnswer}`;
  const list=document.getElementById('st-list');list.innerHTML='';

  data.standings.forEach((p,i)=>{
    const mistakes=(data.questionIndex+1)-p.score;
    const fallPct=(mistakes/data.totalQuestions)*100;
    const color=pColor(p.id);
    const row=document.createElement('div');row.className='p-row';
    if(!p.correct)row.classList.add('fell');
    row.style.marginLeft=Math.min(fallPct*0.4,50)+'px';

    row.innerHTML=`
      <div class="p-depth-bar" style="width:${fallPct}%;background:${color}"></div>
      <div class="p-rank">#${i+1}</div>
      <div class="p-avatar" style="background:${color}22;color:${color}">${p.name[0].toUpperCase()}</div>
      <div class="p-info">
        <div class="p-name">${p.name}${p.id===myId?' (you)':''}</div>
        <div class="p-status ${p.correct?'ok':data.results[p.id]?.chosen!==undefined?'ko':'no'}">
          ${p.correct?'‚úì Correct':data.results[p.id]?.chosen!==undefined?'‚úó Wrong':'‚Äî No answer'}
        </div>
      </div>
      <div class="p-score" style="color:${color}">${p.score}/${data.questionIndex+1}</div>
    `;
    list.appendChild(row);
  });

  document.getElementById('b-next').style.display=isHost?'inline-block':'none';
  document.getElementById('w-next').style.display=isHost?'none':'block';
}

document.getElementById('b-next').onclick=()=>socket.emit('next-question');

socket.on('game-over',scores=>{
  show('gameover');
  document.getElementById('go-winner').textContent=scores[0]?.name||'???';
  const list=document.getElementById('go-list');list.innerHTML='';
  const medals=['ü•á','ü•à','ü•â'];
  scores.forEach((p,i)=>{
    const r=document.createElement('div');r.className='fr';
    r.innerHTML=`<div class="fr-r">${medals[i]||'#'+(i+1)}</div><div class="fr-n">${p.name}${p.id===myId?' (you)':''}</div><div class="fr-s">${p.score}/${totalQ}</div>`;
    list.appendChild(r);
  });
});
document.getElementById('b-replay').onclick=()=>{if(isHost)socket.emit('start-game')};
</script>
</body>
</html>
